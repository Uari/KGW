<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mybatis.mapper.AttendanceMapper">

    <insert id="insertData" parameterType="com.vo.AttendanceVO">
        insert into attendance (attendance_no, emp_no, work_date, start_time, end_time, state, reg_date)
        values (attendance_pk_seq.nextval, #{emp_no}, to_char(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul','YYYY-MM-DD'), #{start_time, jdbcType=VARCHAR}, #{end_time, jdbcType=VARCHAR}, #{state, jdbcType=VARCHAR}, to_char(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul', 'YYYY-MM-DD HH24:MI:SS'))
    </insert>

    <update id="updateData" parameterType="com.vo.AttendanceVO">
        update attendance set
            end_time = #{end_time},
            state = CASE
                    WHEN #{start_time} &lt; '09:00:00' AND #{end_time} &lt; '18:00:00' THEN '조퇴'
                    WHEN #{start_time} &lt; '09:00:00' AND #{end_time} &gt; '18:00:00' THEN '정상출근'
                    WHEN #{start_time} &gt; '09:00:00' AND #{end_time} &gt; '18:00:00' THEN '지각'
                    ELSE '비정상출근'
                END
        where attendance_no = #{attendance_no}
    </update>

    <select id="selectDate" parameterType="int" resultType="com.vo.AttendanceVO">
        select attendance_no, b.emp_no, b.name, work_date, start_time, end_time, state, a.reg_date
        from attendance a join emp b
        on a.EMP_NO = b.EMP_NO
        where b.emp_no = #{emp_no}
          and a.work_date = to_char(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul','YYYY-MM-DD')
    </select>

    <select id="selectOne" parameterType="int" resultType="com.vo.AttendanceVO">
        select attendance_no, emp_no, work_date, start_time, end_time, state, reg_date from attendance
        where emp_no = #{emp_no}
    </select>

    <insert id="insertAbsenteeism">
        INSERT INTO ATTENDANCE (attendance_no, emp_no, work_date, state)
        SELECT attendance_pk_seq.nextval, e.emp_no, to_char(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul','YYYY-MM-DD'), '결근'
        FROM EMP e
        WHERE NOT EXISTS(
            SELECT 1
            FROM ATTENDANCE
            WHERE work_date is null
              AND emp_no = e.emp_no
            )
    </insert>

    <insert id="attendaceModify" parameterType="com.vo.AttendanceVO">
        INSERT INTO attendancemodify (ATTENDANCEMOD_NO, ATTENDANCE_NO, REG_DATE, ORIGINAL_START_TIME, ORIGINAL_END_TIME,
                                      ORIGINAL_STATE, REQUEST_CONTENT, MOD_DATE, MOD_CONTENT, STATE, MOD_STATE)
        values (ATTENDANCEMOD_PK_SEQ.nextval, #{ATTENDANCE_NO}, )
    </insert>

</mapper>
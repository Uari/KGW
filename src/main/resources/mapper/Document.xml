<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

 <mapper namespace="com.example.mapper.DocumentMapper">

    <select id="selectDocument" parameterType="com.vo.ApprovalVO" resultType="com.vo.ApprovalVO">
        SELECT *
        FROM document LEFT JOIN approval
            ON document.document_no = approval.document_no
<<<<<<< HEAD
            <where>
                <if test="emp_no != null"> AND document.emp_no = ${emp_no}</if>
                <if test="gubun !=null">
                    <choose>
                        <when test='gubun == "true"'>
                            AND document.state = '임시저장'
                            <if test="document_no != null"> AND document.document_no = ${document_no}</if>
                        </when>
                        <when test='gubun=="false"'>
                            AND document.state != '임시저장'
                        </when>
                    </choose>
                </if>
            </where>
=======
        <where>
            <if test="storage != null">
                <choose>
                    <when test='storage == "true"'>
                        AND document.state = '임시저장'
                        <if test="document_no != null">
                            AND document.document_no = #{document_no}
                        </if>
                        <!-- 임시저장시 구분 검색 -->
                        <if test="gubun != null">
                            <choose>
                                <when test='gubun.equals("document_title")'>
                                    AND  document.document_title LIKE '%' || #{keyword} || '%'
                                </when>
                                <when test='gubun.equals("document_category")'>
                                    AND document.document_category LIKE '%' || #{keyword} || '%'
                                </when>
                            </choose>
                        </if>
                    </when>

                    <when test='storage == "false"'>
                        AND document.state != '임시저장'
                        <!--기안문서함시 구분검색 -->
                        <if test="gubun != null">
                            <choose>
                                <when test='gubun.equals("document_title")'>
                                    AND document.document_title LIKE '%' || #{keyword} || '%'
                                </when>
                                <when test='gubun.equals("document_category")'>
                                    AND document.document_category LIKE '%' || #{keyword} || '%'
                                </when>
                            </choose>
                        </if>
                    </when>
                </choose>
            </if>
        </where>
>>>>>>> kjh
            order by document.document_no desc
        </select>

        <!--   결재자 select -->
    <select id="approvalDocument" parameterType="com.vo.ApprovalVO" resultType="com.vo.ApprovalVO">
        SELECT
            e.name, t.team_name , d.*, a.*
        FROM
            document d INNER JOIN approval a
                                  ON d.document_no = a.document_no
                       INNER JOIN emp e
                                  ON d.emp_no = e.emp_no
                       INNER JOIN  team t
                                   ON e.team_no = t.team_no
        <where>
            <if test="document_no !=null"> AND d.document_no = #{document_no}</if>

<!--            <if test="gubun != null">-->
<!--                <choose>-->
<!--                    <when test='gubun.equals("document_title")'>-->
<!--                        AND document.document_title LIKE '%' || #{keyword} || '%'-->
<!--                    </when>-->
<!--                    <when test='gubun.equals("document_category")'>-->
<!--                        AND document.document_category LIKE '%' || #{keyword} || '%'-->
<!--                    </when>-->
<!--                </choose>-->
<!--            </if>-->

        </where>
        order by a.document_no desc
    </select>




<!--영입 계약필요한 데이터 -->
    <select id="faTeam" parameterType="com.vo.ApprovalVO" resultType="com.vo.ApprovalVO">
        SELECT fa_no,
               fa_team,
               fa_name ,
               fa_state,
               fa_agent
                FROM fa
    </select>



<!--    <select id="k_List" parameterType="com.vo.ApprovalVO" resultType="map">-->
<!--        SELECT k_no, k_name-->
<!--        FROM kiwoom-->
<!--    </select>-->




<!--영입 문서만 insert-->
    <insert id="documentInsert" parameterType="com.vo.ApprovalVO" useGeneratedKeys="true" keyColumn="document_no" keyProperty="document_no">
        INSERT INTO document (
            document_no,
            emp_no,
            document_title,
            document_category,
            k_name,
            start_date,
            end_date,
            dayoff_content,
            salary,
            contract_term,
            state,
            draftday
        )
        VALUES (
               document_pk_seq.nextval,
               #{emp_no},
               #{document_title},
               #{document_category},
               #{k_name,jdbcType=VARCHAR},
               #{start_date,jdbcType=VARCHAR},
               #{end_date,jdbcType=VARCHAR},
               #{dayoff_content,jdbcType=VARCHAR},
               #{salary,jdbcType=INTEGER},
               #{contract_term,jdbcType=VARCHAR},
               #{state},
               to_char(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul','YYYY-MM-DD HH24:MI:SS')
               )
    </insert>


    <insert id="approvalInsert" parameterType="com.vo.ApprovalVO" >
        INSERT INTO approval (
        approval_no, document_no, approval_name,
        rejection_content, middle_approval_date, final_approval_date, middlesign_name, finalsign_name)
        VALUES (approval_pk_seq.nextval, #{document_no}, #{approval_name, jdbcType=VARCHAR},
                #{rejection_content, jdbcType=VARCHAR}, #{middle_approval_date, jdbcType=VARCHAR}, #{final_approval_date, jdbcType=VARCHAR},  #{middlesign_name, jdbcType=VARCHAR}, #{finalsign_name, jdbcType=VARCHAR})
    </insert>


<!--insert 끝 -->


    <update id="approvalMiddleModify" parameterType="com.vo.ApprovalVO">
        update approval
        set
           approval_category = #{approval_category},
            rejection_content = #{rejection_content,jdbcType=VARCHAR},
            middle_approval_date= to_char(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul','YYYY-MM-DD HH24:MI:SS'),
            middlesign_name=#{middlesign_name}
        where approval_no = #{approval_no}
    </update>


    <update id="approvalFinalModify" parameterType="com.vo.ApprovalVO">
        UPDATE approval
        SET
            approval_category = #{approval_category},
            rejection_content = #{rejection_content, jdbcType=VARCHAR},
            final_approval_date = TO_CHAR(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul', 'YYYY-MM-DD HH24:MI:SS'),
            finalsign_name=#{finalsign_name}
        WHERE approval_no = #{approval_no}
    </update>


    <update id="documentStateModify" parameterType="com.vo.ApprovalVO">
        UPDATE document
        SET state = #{state}
        WHERE document_no = #{document_No}
    </update>




<!--    임시정장부분   -->
    <update id="saveModify" parameterType="com.vo.ApprovalVO">
    update document
    set
        document_category = #{document_category},
        document_title = #{document_title},
        start_date = #{start_date,jdbcType=VARCHAR},
        end_date = #{end_date,jdbcType=VARCHAR},
        dayoff_content = #{dayoff_content,jdbcType=VARCHAR},
        k_name = #{k_name,jdbcType=VARCHAR},
        salary = #{salary,jdbcType=INTEGER},
        contract_term = #{contract_term,jdbcType=VARCHAR},
        state =  #{state}
    where document_no = #{document_no}
</update>

<!--임시저장 삭제  걸재+문서동시   approval delete가 먼전이다  fk 의존성으로 생성됐슴으로 -->

    <delete id="documentDelete" parameterType="int">
        delete from document
               where document_no= #{document_no}
    </delete>



<!--    kjh test update qury      action 는임의 추가하는 값이다  like gubun  true 는 승인 false 는 반려로 정함-->
    <update id="updateApprovalStatus" parameterType="com.vo.ApprovalVO">
        UPDATE approval
        <set>
            <!-- 현재 상태가 "중간결재대기"이고, 동작이 "동의"일 때 -->
            <if test="approval_category == '중간결재대기' and action == 'true'">
                SET approval_category = '최종결재대기',
                middle_approval_date = to_char(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul','YYYY-MM-DD HH24:MI:SS'),
                middlesign_name = #{middlesign_name}
            </if>
            <!-- 현재 상태가 "중간결재대기"이고, 동작이 "반려"일 때 -->
            <if test="approval_category == '중간결재대기' and action == 'false'">
                SET approval_category = '중간반려',
                rejection_content = #{rejection_content},
                middle_approval_date = to_char(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul','YYYY-MM-DD HH24:MI:SS')
            </if>
            <!-- 현재 상태가 "최종결재대기"이고, 동작이 "동의"일 때 -->
            <if test="approval_category == '최종결재대기' and action == 'true'">
                SET approval_category = '최종결재완성',
                final_approval_date = to_char(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul','YYYY-MM-DD HH24:MI:SS'),
                finalsign_name = #{finalsign_name}
            </if>
            <!-- 현재 상태가 "최종결재대기"이고, 동작이 "반려"일 때 -->
            <if test="approval_category == '최종결재대기' and action == 'false'">
                SET approval_category = '최종반려',
                rejection_content = #{rejection_content},
                final_approval_date = to_char(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul','YYYY-MM-DD HH24:MI:SS')
            </if>
        </set>
        WHERE  approval_no = #{approval_no}
    </update>





</mapper>




<!--
<select id="selectDocument" parameterType="com.vo.ApprovalVO" resultType="com.vo.ApprovalVO">
        SELECT *
        FROM document LEFT JOIN approval
            ON document.document_no = approval.document_no
            <where>
                <if test="storage !=null">
                    <choose>
                        <when test='storage == "true"'>
                            AND document.state = '임시저장'
                            <if test="document_no != null"> AND document.document_no = ${document_no}</if>
                        </when>
                        <when test='storage=="false"'>
                            AND document.state != '임시저장'
                        </when>
                    </choose>
                </if>
            </where>
            order by document.document_no desc
        </select>
        -->